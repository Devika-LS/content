commonfields:
  id: ShowOnMap
  version: -1
name: ShowOnMap
script: >
  var lat = parseFloat(args.lat);
  var lng = parseFloat(args.lng);
  var address = args.address;

  if (isNaN(lat) || isNaN(lng)) {
      var instances = executeCommand("GetInstances", {"brand" : "GoogleMaps"});

    // An active instance of GoogleMaps exists, geocoding is possible
      if (instances[0].EntryContext.Modules){
          var commandResult = executeCommand("google-maps-geocode", {"search_address" : address});
          var ec = commandResult[0].EntryContext["GoogleMaps(val.lat && val.lat == obj.lat && val.lng && val.lng == obj.lng)"];

          if (ec)
          {
              lat = ec.lat;
              lng = ec.lng;
          }
          else { // EntryContext could not be parsed correctly
              return {
                  ContentsFormat: formats.text,
                  Type: entryTypes.error,
                  Contents: "Geocoding failed."
              };
          }
      }

      else { // No active GoogleMaps integration available
          return {
              ContentsFormat: formats.text,
              Type: entryTypes.error,
              Contents:"No active GoogleMaps integration found, please configure one to show addresses on map (or provide ShowOnMap coordinates as input)."
          };
      }
  }

  //  lat,lng are not null (whether they were valid arguments or geocoded)

  var locationObj = {
    lat: lat,
    lng: lng
  };

  return {
    Type: entryTypes.map,
    ContentsFormat: formats.json,
    Contents: locationObj
  };

type: javascript
tags:
- Utility
comment: Returns a map entry with marker on the given coordinates (lat, lng), or address
  (requires a configured GoogleMaps instance)
enabled: true
args:
- name: lat
  required: false
  default: true
  description: Latitude (e.g. 32.064622)
- name: lng
  required: false
  description: Longitude (e.g. 34.774131)
- name: address
  default: true
  required: false
  description: Address (will be converted to coordinates and then shown)
scripttarget: 0
fromversion: 5.0.0